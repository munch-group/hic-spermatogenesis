<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Open2C framework – Søren's MSc project about Hi-C and spermatogenesis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../gwf_map_reads.html" rel="next">
<link href="../notebooks/01_hicexplorer.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/001_weather.html">Notebooks</a></li><li class="breadcrumb-item"><a href="../notebooks/02_open2c_framework.html"><span class="chapter-title">Open2C framework</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Søren’s MSc project about Hi-C and spermatogenesis</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Project</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../thoughts.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Thoughts and Prayers</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Notebooks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/001_weather.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Danish weather</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/002_interaction.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Workplace interaction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/01_hicexplorer.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">HiCExplorer using macaque data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/02_open2c_framework.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">Open2C framework</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Workflows</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gwf_map_reads.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">gwf_map_reads</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gwf_bowtie.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">gwf_bowtie</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gwf_bowtie_local.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">gwf_bowtie_local</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gwf_hiccorrect.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">gwf_hiccorrect</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gwf_bwamem.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">gwf_bwamem</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gwf_pair_alignments.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">gwf_pair_alignments</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Reports</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../results/Readme.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Result files</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reports/manuscript.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Correlating Chromatin Compartments with Selection</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reports/supplementary.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Supplementary info</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#pairtools-convert-sequencing-data-to-a-list-of-contacts" id="toc-pairtools-convert-sequencing-data-to-a-list-of-contacts" class="nav-link active" data-scroll-target="#pairtools-convert-sequencing-data-to-a-list-of-contacts"><code>pairtools</code>: Convert sequencing data to a list of contacts</a>
  <ul class="collapse">
  <li><a href="#check-out-the-bamfiles" id="toc-check-out-the-bamfiles" class="nav-link" data-scroll-target="#check-out-the-bamfiles">Check out the bamfiles</a></li>
  <li><a href="#pair-and-sort-the-bamfiles-workfflow---turned-out-not-to-work-no-mapped-reads-were-left-after-filtering" id="toc-pair-and-sort-the-bamfiles-workfflow---turned-out-not-to-work-no-mapped-reads-were-left-after-filtering" class="nav-link" data-scroll-target="#pair-and-sort-the-bamfiles-workfflow---turned-out-not-to-work-no-mapped-reads-were-left-after-filtering">Pair and sort the bamfiles (workfflow) - turned out not to work (no mapped reads were left after filtering)</a></li>
  <li><a href="#map-the-reads-again-but-as-pe-reads-in-stead-cooler-recommendation-workflow" id="toc-map-the-reads-again-but-as-pe-reads-in-stead-cooler-recommendation-workflow" class="nav-link" data-scroll-target="#map-the-reads-again-but-as-pe-reads-in-stead-cooler-recommendation-workflow">Map the reads again but as PE reads in stead (<code>cooler</code> recommendation, workflow)</a></li>
  <li><a href="#check-the-sorted-pairs" id="toc-check-the-sorted-pairs" class="nav-link" data-scroll-target="#check-the-sorted-pairs">Check the sorted pairs</a></li>
  <li><a href="#visualize-stats-pairtools-stats" id="toc-visualize-stats-pairtools-stats" class="nav-link" data-scroll-target="#visualize-stats-pairtools-stats">Visualize Stats: <code>pairtools stats</code></a></li>
  <li><a href="#dedup-the-pairs-and-visualize-stats-again" id="toc-dedup-the-pairs-and-visualize-stats-again" class="nav-link" data-scroll-target="#dedup-the-pairs-and-visualize-stats-again">Dedup the pairs and visualize stats again</a></li>
  </ul></li>
  <li><a href="#cooler-make-the-pairs-cool" id="toc-cooler-make-the-pairs-cool" class="nav-link" data-scroll-target="#cooler-make-the-pairs-cool"><code>cooler</code>: Make the pairs <code>cool</code></a></li>
  <li><a href="#cooler-access-and-plot-hi-c-data" id="toc-cooler-access-and-plot-hi-c-data" class="nav-link" data-scroll-target="#cooler-access-and-plot-hi-c-data"><code>cooler</code>: access and plot Hi-C data</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#follow-cooler-walkthrough-from-the-documentation" id="toc-follow-cooler-walkthrough-from-the-documentation" class="nav-link" data-scroll-target="#follow-cooler-walkthrough-from-the-documentation">Follow <code>cooler</code> walkthrough from the documentation</a></li>
  <li><a href="#use-the-new-pairs" id="toc-use-the-new-pairs" class="nav-link" data-scroll-target="#use-the-new-pairs">Use the new pairs</a></li>
  <li><a href="#merge-the-replicates-according-to-sra-id" id="toc-merge-the-replicates-according-to-sra-id" class="nav-link" data-scroll-target="#merge-the-replicates-according-to-sra-id">Merge the replicates according to SRA ID</a></li>
  <li><a href="#zoomify-the-merged-replicates" id="toc-zoomify-the-merged-replicates" class="nav-link" data-scroll-target="#zoomify-the-merged-replicates"><code>zoomify</code> the merged replicates</a></li>
  <li><a href="#balance-the-matrices-iterative-correction" id="toc-balance-the-matrices-iterative-correction" class="nav-link" data-scroll-target="#balance-the-matrices-iterative-correction">Balance the matrices (iterative correction)</a></li>
  </ul></li>
  </ul>
<div class="quarto-code-links"><h2>Code Links</h2><ul><li><a href="https://github.com/munch-group/hic-spermatogenesis/" target="_blank"><i class="bi bi-github"></i>GitHub Repo</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/001_weather.html">Notebooks</a></li><li class="breadcrumb-item"><a href="../notebooks/02_open2c_framework.html"><span class="chapter-title">Open2C framework</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-title">Open2C framework</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="pairtools-convert-sequencing-data-to-a-list-of-contacts" class="level1">
<h1><code>pairtools</code>: Convert sequencing data to a list of contacts</h1>
<section id="check-out-the-bamfiles" class="level2">
<h2 class="anchored" data-anchor-id="check-out-the-bamfiles">Check out the bamfiles</h2>
<div id="db721520-5705-44b6-b20f-2bda8182a1ff" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>cd ..<span class="op">/</span>steps<span class="op">/</span>bowtie2<span class="op">/</span>local<span class="op">/</span>bamfiles</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>samtools view SRR6502335_1.bam <span class="op">|</span> head <span class="op">-</span>n1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SRR6502335.1    16  chr2    194419849   44  149M1S  *   0   0   AGAGAGAAAGAGTAGAAGGGAGAAACAAAGGGCAGGAGAGGGGATAGATGAAGAGGAACTAGACTTTGCACATATTGGCTGGCAATGATGGAATAGTCCAGTTTCAAAGAGTGAGATCTTGTAGTTATCTTCTCATTTATTCACTTAATN  &lt;FFAF-J7AJJA7AFA77-&lt;AAF-7-A7-7A7-FJ&lt;FA7FAA-7--AAA--&lt;&lt;A7FFJAJJJA&lt;-A-F7F7&lt;-A&lt;F7---&lt;A&lt;JJFFAAF7JFAAJ&lt;FFJF-&lt;-FJJFFFFFJFAF&lt;&lt;-AJJJJJFFF-JFJFFJF7AFJFFFAA-AAA#  AS:i:285    XN:i:0  XM:i:2  XO:i:0  XG:i:0  NM:i:2  MD:Z:44G78A25   YT:Z:UU</code></pre>
</div>
</div>
<div id="595e9671-c234-4e4e-8066-61d4d023bf06" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>cd ..<span class="op">/</span>steps<span class="op">/</span>bowtie2<span class="op">/</span>local<span class="op">/</span>bamfiles<span class="op">/</span>paired</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>samtools view SRR6502335_paired.bam <span class="op">|</span> head <span class="op">-</span>n1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SRR6502335.1    0   chr2    194419717   44  10S140M *   0   0   NTTCTGGATCGATCATTTTTACATTATTTTTGCCTATGAACCAACTTTCAAAATTATTTCTCGTTTAAAATACAATTCAATGAGGTATTCATTTTTGTCTGGGGGGAAAGATGGAAGGTAGGAAGAAGAAAGAAGTGAAGAAAGAGAGAA  #AAAFAF&lt;JJJJJJFJJJJJJJ-JJFJJJJJ&lt;JAA-FF-FFAAFJFJFJJ--7&lt;F-AJFFAJFFFJF-7FF-FJF&lt;FFJFJFFF&lt;JA&lt;AJA7&lt;AJ&lt;AJFJ&lt;---77-7--7-7&lt;AAFFAF77&lt;FJ-&lt;&lt;--7-AFJ---7AF&lt;AAF--7&lt;7  AS:i:275    XN:i:0  XM:i:1  XO:i:0  XG:i:0  NM:i:1  MD:Z:125G14 YT:Z:UU</code></pre>
</div>
</div>
<section id="i-had-to-decompress-the-reference-genome" class="level3">
<h3 class="anchored" data-anchor-id="i-had-to-decompress-the-reference-genome">I had to decompress the reference genome</h3>
<p>To make <code>samtools faidx</code> work (or compress with <code>bgzip</code>, not <code>gunzip</code>)</p>
<div id="5f8a39ff-1564-49b2-aa11-32e7d6a34de2" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>cd <span class="op">/</span>home<span class="op">/</span>sojern<span class="op">/</span>hic<span class="op">-</span>spermatogenesis<span class="op">/</span>data<span class="op">/</span>macaque_raw<span class="op">/</span>ucsc_ref</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>gunzip <span class="op">-</span>k rheMac10.fa.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="pair-and-sort-the-bamfiles-workfflow---turned-out-not-to-work-no-mapped-reads-were-left-after-filtering" class="level2">
<h2 class="anchored" data-anchor-id="pair-and-sort-the-bamfiles-workfflow---turned-out-not-to-work-no-mapped-reads-were-left-after-filtering">Pair and sort the bamfiles (workfflow) - turned out not to work (no mapped reads were left after filtering)</h2>
<div id="991da872" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, Markdown</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the content of the Python file</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'../gwf_pair_alignments.py'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    file_content <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the content as Markdown</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="ss">f"```python</span><span class="ch">\n</span><span class="sc">{</span>file_content<span class="sc">}</span><span class="ch">\n</span><span class="ss">```"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %% [markdown]</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ---</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># title: "gwf_bowtie_local"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># author: Søren Jørgensen</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># date: last-modified</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># execute: </span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   enabled: false</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ---</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># %%</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gwf <span class="im">import</span> <span class="op">*</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> op</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">#######################################</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co"># GWF workflow to pair alignments from mate-pair sequencing, after mapping to the reference individually.</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># After mapping, the mate-pairs are merged with `samtools merge` (another workflow) and then parsed with `pairtools parse`. </span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co"># How to run:</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co"># conda activate gwf</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co"># gwf -f gwf_gwf_pair_alignments.py status</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Workflow:</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   1   pairtools parse : Parse the fastq files into pairs (after merging with `samtools merge`)</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Footnote: always activate the conda environment before running the workflow:</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="co"># source $(conda info --base)/etc/profile.d/conda.sh</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co"># conda activate env_name</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co">#######################################</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a workflow object</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>gwf <span class="op">=</span> Workflow(defaults<span class="op">=</span>{<span class="st">'nodes'</span>: <span class="dv">1</span>, <span class="st">'queue'</span>:<span class="st">"normal"</span>, <span class="st">'account'</span>:<span class="st">"hic-spermatogenesis"</span>})</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co">#############################################</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="co">############### Templates ###################</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="co">#############################################</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pair_sort_alignments(chromsizes, bam_merged, sorted_pairs):</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Pair the merged alignments from mate-pair sequencing with `pairtools parse`"""</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> [bam_merged]</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>bam_merged<span class="sc">}</span><span class="ss">_parsed.stats"</span>, </span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>               sorted_pairs]</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    options <span class="op">=</span> {<span class="st">'cores'</span>:<span class="dv">12</span>, <span class="st">'memory'</span>:<span class="st">"4g"</span>, <span class="st">'walltime'</span>:<span class="st">"01:00:00"</span>}</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    spec<span class="op">=</span><span class="ss">f"""</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a><span class="ss">source $(conda info --base)/etc/profile.d/conda.sh</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a><span class="ss">conda activate hic</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="ss">pairtools parse </span><span class="ch">\</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a><span class="ss">    -c </span><span class="sc">{</span>chromsizes<span class="sc">}</span><span class="ss"> </span><span class="ch">\</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="ss">    --drop-sam --drop-seq </span><span class="ch">\</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a><span class="ss">    --output-stats </span><span class="sc">{</span>bam_merged<span class="sc">}</span><span class="ss">_parsed.stats </span><span class="ch">\</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="ss">    --add-columns mapq </span><span class="ch">\</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="ss">    --assembly rheMac10 --no-flip </span><span class="ch">\</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a><span class="ss">    --walks-policy mask </span><span class="ch">\</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="sc">{</span>bam_merged<span class="sc">}</span><span class="ss"> | </span><span class="ch">\</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="ss">pairtools sort -o </span><span class="sc">{</span>sorted_pairs<span class="sc">}</span><span class="ss"> </span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> AnonymousTarget(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs, options<span class="op">=</span>options, spec<span class="op">=</span>spec)</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dedup(sorted_pairs, ):</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Deduplicate the sorted pairs with `pairtools dedup`"""</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    pairs_prefix <span class="op">=</span> sorted_pairs.split(<span class="st">".sorted"</span>)[<span class="dv">0</span>]</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> [sorted_pairs]</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.nodups.pairs.gz"</span>,</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.nodups.bam"</span>,</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.unmapped.pairs.gz"</span>,</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.unmapped.bam"</span>,</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dups.pairs.gz"</span>,</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dups.bam"</span>,</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dedup.stats"</span>]</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    options <span class="op">=</span> {<span class="st">'cores'</span>:<span class="dv">12</span>, <span class="st">'memory'</span>: <span class="st">"4g"</span>, <span class="st">'walltime'</span>: <span class="st">"01:00:00"</span>}</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>    spec <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a><span class="ss">source $(conda info --base)/etc/profile.d/conda.sh</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a><span class="ss">conda activate hic</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a><span class="ss">pairtools dedup </span><span class="ch">\</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a><span class="ss">    --max-mismatch 3 </span><span class="ch">\</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a><span class="ss">    --mark-dups </span><span class="ch">\</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a><span class="ss">    --output </span><span class="ch">\</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a><span class="ss">        &gt;(pairtools split </span><span class="ch">\</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-pairs </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.nodups.pairs.gz </span><span class="ch">\</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-sam </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.nodups.bam </span><span class="ch">\</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a><span class="ss">         ) </span><span class="ch">\</span></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a><span class="ss">    --output-unmapped </span><span class="ch">\</span></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a><span class="ss">        &gt;( pairtools split </span><span class="ch">\</span></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-pairs </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.unmapped.pairs.gz </span><span class="ch">\</span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-sam </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.unmapped.bam </span><span class="ch">\</span></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a><span class="ss">         ) </span><span class="ch">\</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a><span class="ss">    --output-dups </span><span class="ch">\</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a><span class="ss">        &gt;( pairtools split </span><span class="ch">\</span></span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-pairs </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dups.pairs.gz </span><span class="ch">\</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-sam </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dups.bam </span><span class="ch">\</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a><span class="ss">            ) </span><span class="ch">\</span></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a><span class="ss">    --output-stats </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dedup.stats </span><span class="ch">\</span></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="sc">{</span>sorted_pairs<span class="sc">}</span></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> AnonymousTarget(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs, options<span class="op">=</span>options, spec<span class="op">=</span>spec)</span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a><span class="co">#############################################</span></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a><span class="co">################ Targets ####################</span></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a><span class="co">#############################################</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the chromsizes file</span></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>chromsizes <span class="op">=</span> <span class="st">"data/links/ucsc_ref/misc/rheMac10.chrom.sizes"</span></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the merged bam files</span></span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>merged_bams <span class="op">=</span> gwf.glob(<span class="st">"steps/bowtie2/local/bamfiles/paired/*_paired.bam"</span>)</span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>sorted_bams <span class="op">=</span> <span class="bu">sorted</span>(merged_bams)</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> inbam <span class="kw">in</span> sorted_bams:</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>    base <span class="op">=</span> op.basename(inbam)</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>    prefix <span class="op">=</span> base.split(<span class="st">"_paired"</span>)[<span class="dv">0</span>]</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>    outdir <span class="op">=</span> <span class="st">"steps/bowtie2/local/bamfiles/paired/"</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>    outfile <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base<span class="sc">.</span>split(<span class="st">"_paired"</span>)[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span> <span class="op">+</span> <span class="st">".sorted.pairs.gz"</span></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>    out_sorted_pairs <span class="op">=</span> op.join(outdir, outfile)</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>    gwf.target_from_template(<span class="ss">f"pair_sort_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>                            pair_sort_alignments(chromsizes, inbam, out_sorted_pairs))</span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>    gwf.target_from_template(<span class="ss">f"dedup_</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>                            dedup(out_sorted_pairs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="map-the-reads-again-but-as-pe-reads-in-stead-cooler-recommendation-workflow" class="level2">
<h2 class="anchored" data-anchor-id="map-the-reads-again-but-as-pe-reads-in-stead-cooler-recommendation-workflow">Map the reads again but as PE reads in stead (<code>cooler</code> recommendation, workflow)</h2>
<div id="db94d86e-a9aa-41ad-b383-09e7917fb684" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, Markdown</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the content of the Python file</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'../gwf_bwamem.py'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    file_content <span class="op">=</span> <span class="bu">file</span>.read()</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the content as Markdown</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="ss">f"```python</span><span class="ch">\n</span><span class="sc">{</span>file_content<span class="sc">}</span><span class="ch">\n</span><span class="ss">```"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># %% [markdown]</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ---</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># title: "gwf_map_reads"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># author: Søren Jørgensen</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># date: last-modified</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># execute: </span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   enabled: false</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ---</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># %%</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gwf <span class="im">import</span> <span class="op">*</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">#######################################</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># GWF workflow to map Hi-C reads to pairs with `bwa` and `samtools`.</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Pairs are generated with `pairtools parse` and deduplicated with `pairtools dedup`.</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co"># How to run:</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># conda activate gwf</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co"># gwf -f gwf_bwamem.py status</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Workflow:</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   1a bwa_index        : [Reference genome] Index the reference genome with `bwa index`</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   1b sam_index        : [Reference genome] Index the fasta again with `samtools faidx``</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   2  bwa_map          : Map reads (PE) to the reference with `bwa mem` </span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co">#   3  pair_sort        : Pair the merged alignments from mate-pair sequencing with `pairtools parse`, </span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="co">#                         then sort with `pairtools sort`</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co">#   4  dedup            : Deduplicate the sorted pairs with `pairtools dedup`  </span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="co">#######################################</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a workflow object</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>gwf <span class="op">=</span> Workflow(defaults<span class="op">=</span>{<span class="st">'nodes'</span>: <span class="dv">1</span>, <span class="st">'queue'</span>:<span class="st">"normal"</span>, <span class="st">'account'</span>:<span class="st">"hic-spermatogenesis"</span>})</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="co">#############################################</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="co">############### Templates ###################</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="co">#############################################</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bwa_index(ref_genome):</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Template for indexing the reference genome with bwa"""</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    inputs  <span class="op">=</span> [ref_genome]</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.amb"</span>, </span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.ann"</span>, </span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.bwt"</span>, </span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.pac"</span>, </span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.sa"</span>]</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    options <span class="op">=</span> {<span class="st">'cores'</span>:<span class="dv">1</span>, <span class="st">'memory'</span>: <span class="st">"5g"</span>, <span class="st">'walltime'</span>:<span class="st">"02:00:00"</span>}</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    spec <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a><span class="ss">source $(conda info --base)/etc/profile.d/conda.sh</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="ss">conda activate hic</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a><span class="ss">bwa index -p </span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss"> -a bwtsw </span><span class="sc">{</span>ref_genome<span class="sc">}</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a><span class="ss">'''</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> AnonymousTarget(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs, options<span class="op">=</span>options, spec<span class="op">=</span>spec)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sam_index(ref_genome):</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Creating a Fasta index. `bwa mem` also needs a fasta index generated by samtools"""</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> [ref_genome]</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.fai"</span>]</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    options <span class="op">=</span> {<span class="st">'cores'</span>:<span class="dv">1</span>, <span class="st">'memory'</span>:<span class="st">"5g"</span>, <span class="st">'walltime'</span>:<span class="st">"00:20:00"</span>}</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    spec<span class="op">=</span><span class="ss">f"""</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a><span class="ss">source $(conda info --base)/etc/profile.d/conda.sh</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a><span class="ss">conda activate hic</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="ss">samtools faidx </span><span class="sc">{</span>ref_genome<span class="sc">}</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> AnonymousTarget(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs, options<span class="op">=</span>options, spec<span class="op">=</span>spec)</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bwa_map(ref_genome, mate_1, mate_2, out_bam):</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="co">    Template for mapping reads to a reference genome using `bwa` and `samtools`. </span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a><span class="co">    NB! Here, we map the mates together, as bwa states it is no problem for Hi-C reads. </span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    threads <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.amb"</span>, </span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.ann"</span>, </span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.bwt"</span>, </span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.pac"</span>, </span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.sa"</span>, </span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss">.fai"</span>,</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>              mate_1, mate_2]</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> [out_bam]</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    options <span class="op">=</span> {<span class="st">'cores'</span>:threads, <span class="st">'memory'</span>: <span class="st">"32g"</span>, <span class="st">'walltime'</span>:<span class="st">"06:00:00"</span>}</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>    spec <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a><span class="ss">source $(conda info --base)/etc/profile.d/conda.sh</span></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a><span class="ss">conda activate hic</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a><span class="ss">bwa mem -t </span><span class="sc">{</span>threads<span class="sc">}</span><span class="ss"> -SP </span><span class="sc">{</span>ref_genome<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>mate_1<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>mate_2<span class="sc">}</span><span class="ss"> &gt; </span><span class="sc">{</span>out_bam<span class="sc">}</span></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> AnonymousTarget(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs, options<span class="op">=</span>options, spec<span class="op">=</span>spec)</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pair_sort_alignments(chromsizes, bam_merged, sorted_pairs):</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Pair the merged alignments from mate-pair sequencing with `pairtools parse`"""</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> [bam_merged]</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>bam_merged<span class="sc">}</span><span class="ss">_parsed.stats"</span>, </span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>               sorted_pairs]</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>    options <span class="op">=</span> {<span class="st">'cores'</span>:<span class="dv">12</span>, <span class="st">'memory'</span>:<span class="st">"4g"</span>, <span class="st">'walltime'</span>:<span class="st">"02:00:00"</span>}</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>    spec<span class="op">=</span><span class="ss">f"""</span></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a><span class="ss">source $(conda info --base)/etc/profile.d/conda.sh</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a><span class="ss">conda activate hic</span></span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a><span class="ss">pairtools parse </span><span class="ch">\</span></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a><span class="ss">    -c </span><span class="sc">{</span>chromsizes<span class="sc">}</span><span class="ss"> </span><span class="ch">\</span></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a><span class="ss">    --drop-sam --drop-seq </span><span class="ch">\</span></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a><span class="ss">    --output-stats </span><span class="sc">{</span>bam_merged<span class="sc">}</span><span class="ss">_parsed.stats </span><span class="ch">\</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a><span class="ss">    --add-columns mapq </span><span class="ch">\</span></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a><span class="ss">    --assembly rheMac10 --no-flip </span><span class="ch">\</span></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a><span class="ss">    --walks-policy mask </span><span class="ch">\</span></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="sc">{</span>bam_merged<span class="sc">}</span><span class="ss"> | </span><span class="ch">\</span></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a><span class="ss">pairtools sort -o </span><span class="sc">{</span>sorted_pairs<span class="sc">}</span><span class="ss"> </span></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> AnonymousTarget(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs, options<span class="op">=</span>options, spec<span class="op">=</span>spec)</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dedup(sorted_pairs):</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Deduplicate the sorted pairs with `pairtools dedup`"""</span></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>    pairs_prefix <span class="op">=</span> sorted_pairs.split(<span class="st">".sorted"</span>)[<span class="dv">0</span>]</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> [sorted_pairs]</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.nodups.pairs.gz"</span>,</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.nodups.bam"</span>,</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.unmapped.pairs.gz"</span>,</span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.unmapped.bam"</span>,</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dups.pairs.gz"</span>,</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dups.bam"</span>,</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>               <span class="ss">f"</span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dedup.stats"</span>]</span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>    options <span class="op">=</span> {<span class="st">'cores'</span>:<span class="dv">12</span>, <span class="st">'memory'</span>: <span class="st">"4g"</span>, <span class="st">'walltime'</span>: <span class="st">"01:00:00"</span>}</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>    spec <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a><span class="ss">source $(conda info --base)/etc/profile.d/conda.sh</span></span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a><span class="ss">conda activate hic</span></span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a><span class="ss">pairtools dedup </span><span class="ch">\</span></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a><span class="ss">    --max-mismatch 3 </span><span class="ch">\</span></span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a><span class="ss">    --mark-dups </span><span class="ch">\</span></span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a><span class="ss">    --output </span><span class="ch">\</span></span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a><span class="ss">        &gt;(pairtools split </span><span class="ch">\</span></span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-pairs </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.nodups.pairs.gz </span><span class="ch">\</span></span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-sam </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.nodups.bam </span><span class="ch">\</span></span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a><span class="ss">         ) </span><span class="ch">\</span></span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a><span class="ss">    --output-unmapped </span><span class="ch">\</span></span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a><span class="ss">        &gt;( pairtools split </span><span class="ch">\</span></span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-pairs </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.unmapped.pairs.gz </span><span class="ch">\</span></span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-sam </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.unmapped.bam </span><span class="ch">\</span></span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a><span class="ss">         ) </span><span class="ch">\</span></span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a><span class="ss">    --output-dups </span><span class="ch">\</span></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a><span class="ss">        &gt;( pairtools split </span><span class="ch">\</span></span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-pairs </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dups.pairs.gz </span><span class="ch">\</span></span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a><span class="ss">            --output-sam </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dups.bam </span><span class="ch">\</span></span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a><span class="ss">            ) </span><span class="ch">\</span></span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a><span class="ss">    --output-stats </span><span class="sc">{</span>pairs_prefix<span class="sc">}</span><span class="ss">.dedup.stats </span><span class="ch">\</span></span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a><span class="ss">    </span><span class="sc">{</span>sorted_pairs<span class="sc">}</span></span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a><span class="ss">    """</span></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> AnonymousTarget(inputs<span class="op">=</span>inputs, outputs<span class="op">=</span>outputs, options<span class="op">=</span>options, spec<span class="op">=</span>spec)</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a><span class="co">#############################################</span></span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a><span class="co">############### Create targets ##############</span></span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a><span class="co">#############################################</span></span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a><span class="co"># Do stuff with the [unpacked] reference genome</span></span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>ref_genome <span class="op">=</span> <span class="st">"data/links/ucsc_ref/rheMac10.fa"</span></span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>T1a <span class="op">=</span> gwf.target_from_template(<span class="ss">f"bwa_index_</span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>basename(ref_genome)<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>                               bwa_index(ref_genome<span class="op">=</span>ref_genome))</span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>T1b <span class="op">=</span> gwf.target_from_template(<span class="ss">f"sam_index_</span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>basename(ref_genome)<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>                               sam_index(ref_genome<span class="op">=</span>ref_genome))</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the chromsizes file</span></span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>chromsizes <span class="op">=</span> <span class="st">"data/links/ucsc_ref/misc/rheMac10.chrom.sizes"</span></span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Locate Hi-C reads </span></span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>fastq_folder <span class="op">=</span> <span class="st">"data/links/macaque_fastq/"</span></span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>fastq_files <span class="op">=</span> glob.glob(os.path.join(fastq_folder, <span class="st">"*.fastq.gz"</span>))</span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Pair the files (make sure they have the same base name prefix):</span></span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>fastq_files.sort()</span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>paired_fastq_files <span class="op">=</span> <span class="bu">list</span>(<span class="bu">zip</span>(fastq_files[::<span class="dv">2</span>], fastq_files[<span class="dv">1</span>::<span class="dv">2</span>]))</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> f1,f2 <span class="kw">in</span> paired_fastq_files:</span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the base names</span></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>    basename_1 <span class="op">=</span> os.path.basename(f1).split(<span class="st">'.fast'</span>)[<span class="dv">0</span>]</span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>    basename_2 <span class="op">=</span> os.path.basename(f2).split(<span class="st">'.fast'</span>)[<span class="dv">0</span>]</span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine pair names</span></span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>    pairname <span class="op">=</span> os.path.commonprefix([basename_1, basename_2]).split(<span class="st">'_'</span>)[<span class="dv">0</span>]</span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the output bam filenames</span></span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>    bam_dir <span class="op">=</span> <span class="ss">f"steps/bwa/PE/bamfiles/"</span></span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>    bam_file <span class="op">=</span> pairname <span class="op">+</span> <span class="st">".PE.bam"</span></span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>    out_bam <span class="op">=</span> os.path.join(bam_dir, bam_file)</span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create targets for mapping</span></span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>    T2 <span class="op">=</span> gwf.target_from_template(<span class="ss">f"bwa_map_</span><span class="sc">{</span>pairname<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>                                  bwa_map(ref_genome<span class="op">=</span>ref_genome, </span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a>                                          mate_1<span class="op">=</span>f1, mate_2<span class="op">=</span>f2, </span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>                                          out_bam<span class="op">=</span>out_bam))</span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create targets for sorting the pairs</span></span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a>    pair_dir <span class="op">=</span> <span class="st">"steps/bwa/PE/pairs/"</span></span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a>    pair_file <span class="op">=</span> pairname <span class="op">+</span> <span class="st">".sorted.pairs.gz"</span></span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a>    sorted_pairs <span class="op">=</span> os.path.join(pair_dir, pair_file)</span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>    T3 <span class="op">=</span> gwf.target_from_template(<span class="ss">f"pair_sort_</span><span class="sc">{</span>pairname<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>                                  pair_sort_alignments(chromsizes<span class="op">=</span>chromsizes, </span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a>                                                       bam_merged<span class="op">=</span>out_bam, </span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>                                                       sorted_pairs<span class="op">=</span>sorted_pairs))</span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>    T4 <span class="op">=</span> gwf.target_from_template(<span class="ss">f"dedup_</span><span class="sc">{</span>pairname<span class="sc">}</span><span class="ss">"</span>, dedup(sorted_pairs<span class="op">=</span>sorted_pairs))</span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="check-the-sorted-pairs" class="level2">
<h2 class="anchored" data-anchor-id="check-the-sorted-pairs">Check the sorted pairs</h2>
<div id="23a1e8e8-ab2a-46ae-bcf8-236ef05fd4c1" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#cd ../steps/bowtie2/local/bamfiles/paired</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>cd ..<span class="op">/</span>steps<span class="op">/</span>bwa<span class="op">/</span>PE<span class="op">/</span>pairs</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Unique pairs:</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>gzip <span class="op">-</span>dc SRR6502339.nodups.pairs.gz <span class="op">|</span> grep <span class="op">-</span>v <span class="st">'#'</span> <span class="op">|</span>  head <span class="op">-</span>n <span class="dv">5</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"--"</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Only dups</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>gzip <span class="op">-</span>dc SRR6502339.dups.pairs.gz <span class="op">|</span> grep <span class="op">-</span>v <span class="st">'#'</span> <span class="op">|</span>  head <span class="op">-</span>n <span class="dv">5</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"--"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SRR6502339.38272510 chr1    898 chr1    1026    +   -   UU  3   3
SRR6502339.13727657 chr1    976 chr1    175669579   +   -   UR  4   60
SRR6502339.67930411 chr1    1035    chr1    99209   +   -   UU  22  60
SRR6502339.90172213 chr1    1134    chr1    11385306    -   +   UR  9   60
SRR6502339.53849219 chr1    5186    chr1    56858619    +   -   UR  2   60
--
SRR6502339.53849978 chr1    5186    chr1    56858619    +   -   DD  2   60
SRR6502339.67632192 chr1    13335   chr1    370581  +   -   DD  3   7
SRR6502339.92006828 chr1    16215   chr1    16560   +   -   DD  35  12
SRR6502339.71065550 chr1    19644   chr1    62483   +   -   DD  23  60
SRR6502339.89600080 chr1    19644   chr1    62483   +   -   DD  25  60
--</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[main_samview] fail to read the header from "SRR6502339.nodups.bam".</code></pre>
</div>
</div>
</section>
<section id="visualize-stats-pairtools-stats" class="level2">
<h2 class="anchored" data-anchor-id="visualize-stats-pairtools-stats">Visualize Stats: <code>pairtools stats</code></h2>
<p>It might be the same stats that are (optionally) returned from <code>pairtools parse</code>.</p>
<p>Let’s look at the parsed stats in a nice way:</p>
<section id="if-it-is-not-the-same-then-run-this-command-on-all-the-sorted-pairs." class="level3">
<h3 class="anchored" data-anchor-id="if-it-is-not-the-same-then-run-this-command-on-all-the-sorted-pairs.">If it is not the same, then run this command on all the sorted pairs.</h3>
<div id="8f3621d6-b64f-4b8a-8646-a8e34699160d" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>cd ..<span class="op">/</span>steps<span class="op">/</span>bwa<span class="op">/</span>PE<span class="op">/</span>pairs</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">#pairtools stats SRR6502339.sorted.pairs.gz -o test.stats</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="otherwise-just-use-multiqc" class="level3">
<h3 class="anchored" data-anchor-id="otherwise-just-use-multiqc">Otherwise, just use <code>MultiQC</code></h3>
<section id="generate-the-multiqc-files" class="level4">
<h4 class="anchored" data-anchor-id="generate-the-multiqc-files">Generate the MultiQC files</h4>
</section>
<section id="now-visualize" class="level4">
<h4 class="anchored" data-anchor-id="now-visualize">Now visualize:</h4>
<section id="all-results-merged-before-dedup" class="level5">
<h5 class="anchored" data-anchor-id="all-results-merged-before-dedup">All results merged (before dedup)</h5>
<div id="f04020ea-2ba9-458d-b750-78a88bbf35c5" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> IFrame</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>IFrame(src<span class="op">=</span><span class="st">'../steps/bwa/PE/bamfiles/Fibroblasts_all_multiqc_report.html'</span>, width<span class="op">=</span><span class="dv">1400</span>, height<span class="op">=</span><span class="dv">900</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">

        <iframe width="1400" height="900" src="../steps/bwa/PE/bamfiles/Fibroblasts_all_multiqc_report.html" frameborder="0" allowfullscreen=""></iframe>
        
</div>
</div>
<div id="1bc77e7e-e8a2-4990-8914-5b912697c1a3" class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>cd ..<span class="op">/</span>steps<span class="op">/</span>bwa<span class="op">/</span>PE<span class="op">/</span>pairs<span class="op">/</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>multiqc <span class="op">-</span>i Fibroblasts_all.dedup <span class="op">--</span>no<span class="op">-</span>data<span class="op">-</span><span class="bu">dir</span>  <span class="op">*</span>.stats </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
/// d=807531;https://multiqc.info\MultiQC;;\ 🔍 v1.25.1

     update_config | Report title: Fibroblasts_all.dedup
       file_search | Search path: /faststorage/project/hic-spermatogenesis/people/sojern/hic-spermatogenesis/steps/bwa/PE/pairs/SRR6502335.dedup.stats
       file_search | Search path: /faststorage/project/hic-spermatogenesis/people/sojern/hic-spermatogenesis/steps/bwa/PE/pairs/SRR6502336.dedup.stats
       file_search | Search path: /faststorage/project/hic-spermatogenesis/people/sojern/hic-spermatogenesis/steps/bwa/PE/pairs/SRR6502337.dedup.stats
       file_search | Search path: /faststorage/project/hic-spermatogenesis/people/sojern/hic-spermatogenesis/steps/bwa/PE/pairs/SRR6502338.dedup.stats
       file_search | Search path: /faststorage/project/hic-spermatogenesis/people/sojern/hic-spermatogenesis/steps/bwa/PE/pairs/SRR6502339.dedup.stats
         searching | ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 5/5  .dedup.statsmSRR6502338.dedup.stats
         pairtools | Found 5 reports
     write_results | Data        : None
     write_results | Report      : Fibroblasts_all.dedup_multiqc_report.html
           multiqc | MultiQC complete</code></pre>
</div>
</div>
<div id="73441774-1193-4a40-97bc-287483980151" class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> IFrame</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>IFrame(src<span class="op">=</span><span class="st">'../steps/bwa/PE/pairs/Fibroblasts_all.dedup_multiqc_report.html'</span>, width<span class="op">=</span><span class="dv">1400</span>, height<span class="op">=</span><span class="dv">900</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">

        <iframe width="1400" height="900" src="../steps/bwa/PE/pairs/Fibroblasts_all.dedup_multiqc_report.html" frameborder="0" allowfullscreen=""></iframe>
        
</div>
</div>
</section>
</section>
</section>
</section>
<section id="dedup-the-pairs-and-visualize-stats-again" class="level2">
<h2 class="anchored" data-anchor-id="dedup-the-pairs-and-visualize-stats-again">Dedup the pairs and visualize stats again</h2>
<p>The pairs was deduplicated with a gwf workflow <code>gwf_bwamem.py</code></p>
<div id="41e05aa7-8096-4dfe-aea8-a711d0f4ab1e" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>cd ..<span class="op">/</span>steps<span class="op">/</span>bwa<span class="op">/</span>PE<span class="op">/</span>pairs<span class="op">/</span><span class="bu">sorted</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>multiqc <span class="op">-</span>i fibroblast.dedup <span class="op">--</span>no<span class="op">-</span>data<span class="op">-</span><span class="bu">dir</span> <span class="op">*</span>.stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
/// d=271458;https://multiqc.info\MultiQC;;\ 🔍 v1.25.1

     update_config | Report title: fibroblast.dedup
       file_search | Search path: /faststorage/project/hic-spermatogenesis/people/sojern/hic-spermatogenesis/steps/bwa/PE/pairs/sorted/SRR6502335.dedup.stats
       file_search | Search path: /faststorage/project/hic-spermatogenesis/people/sojern/hic-spermatogenesis/steps/bwa/PE/pairs/sorted/SRR6502336.dedup.stats
       file_search | Search path: /faststorage/project/hic-spermatogenesis/people/sojern/hic-spermatogenesis/steps/bwa/PE/pairs/sorted/SRR6502337.dedup.stats
       file_search | Search path: /faststorage/project/hic-spermatogenesis/people/sojern/hic-spermatogenesis/steps/bwa/PE/pairs/sorted/SRR6502338.dedup.stats
       file_search | Search path: /faststorage/project/hic-spermatogenesis/people/sojern/hic-spermatogenesis/steps/bwa/PE/pairs/sorted/SRR6502339.dedup.stats
         searching | ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100% 5/5  0/5  
         pairtools | Found 5 reports
     write_results | Data        : None
     write_results | Report      : fibroblast.dedup_multiqc_report.html
           multiqc | MultiQC complete</code></pre>
</div>
</div>
<div id="64410100-87a0-4e49-b52f-8c33a2a4c083" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> IFrame</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>IFrame(src<span class="op">=</span><span class="st">'../steps/bwa/PE/pairs/sorted/fibroblast.dedup_multiqc_report.html'</span>, width<span class="op">=</span><span class="dv">1400</span>, height<span class="op">=</span><span class="dv">900</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">

        <iframe width="1400" height="900" src="../steps/bwa/PE/pairs/sorted/fibroblast.dedup_multiqc_report.html" frameborder="0" allowfullscreen=""></iframe>
        
</div>
</div>
</section>
</section>
<section id="cooler-make-the-pairs-cool" class="level1">
<h1><code>cooler</code>: Make the pairs <code>cool</code></h1>
<div id="99cac222-3112-435c-90fd-7b917d0f2f0e" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the chromsizes to only include the placed scaffolds</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"Lines in unfiltered chrom.sizes:"</span> $(cat ..<span class="op">/</span>data<span class="op">/</span>links<span class="op">/</span>ucsc_ref<span class="op">/</span>misc<span class="op">/</span>rheMac10.chrom.sizes <span class="op">|</span> grep <span class="op">-</span>c <span class="st">""</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>cat ..<span class="op">/</span>data<span class="op">/</span>links<span class="op">/</span>ucsc_ref<span class="op">/</span>misc<span class="op">/</span>rheMac10.chrom.sizes <span class="op">|</span> grep <span class="op">-</span>Pv <span class="st">"^chrUn|^chrM|_random"</span> <span class="op">|</span> sort <span class="op">-</span>V <span class="op">&gt;</span> ..<span class="op">/</span>data<span class="op">/</span>links<span class="op">/</span>ucsc_ref<span class="op">/</span>misc<span class="op">/</span>rheMac10.filtered.chrom.sizes</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"New filtered.chrom.sizes:"</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>cat ..<span class="op">/</span>data<span class="op">/</span>links<span class="op">/</span>ucsc_ref<span class="op">/</span>misc<span class="op">/</span>rheMac10.filtered.chrom.sizes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Lines in unfiltered chrom.sizes: 2939
New filtered.chrom.sizes:
chr1    223616942
chr2    196197964
chr3    185288947
chr4    169963040
chr5    187317192
chr6    179085566
chr7    169868564
chr8    145679320
chr9    134124166
chr10   99517758
chr11   133066086
chr12   130043856
chr13   108737130
chr14   128056306
chr15   113283604
chr16   79627064
chr17   95433459
chr18   74474043
chr19   58315233
chr20   77137495
chrX    153388924
chrY    11753682</code></pre>
</div>
</div>
<div id="5c4025a3-ac9f-4149-b5d8-d92c17cdc95b" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>cd ..<span class="op">/</span>steps<span class="op">/</span>bwa<span class="op">/</span>PE<span class="op">/</span>pairs<span class="op">/</span><span class="bu">sorted</span><span class="op">/</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>echo $PWD </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>du <span class="op">-</span>ha SRR650233<span class="op">*</span>.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/faststorage/project/hic-spermatogenesis/people/sojern/hic-spermatogenesis/steps/bwa/PE/pairs/sorted \n
287M    SRR6502335.dups.pairs.gz
1.8G    SRR6502335.nodups.pairs.gz
2.7G    SRR6502335.sorted.pairs.gz
722M    SRR6502335.unmapped.pairs.gz
323M    SRR6502336.dups.pairs.gz
1.6G    SRR6502336.nodups.pairs.gz
2.3G    SRR6502336.sorted.pairs.gz
621M    SRR6502336.unmapped.pairs.gz
190M    SRR6502337.dups.pairs.gz
1.3G    SRR6502337.nodups.pairs.gz
1.9G    SRR6502337.sorted.pairs.gz
528M    SRR6502337.unmapped.pairs.gz
131M    SRR6502338.dups.pairs.gz
1.4G    SRR6502338.nodups.pairs.gz
2.0G    SRR6502338.sorted.pairs.gz
512M    SRR6502338.unmapped.pairs.gz
150M    SRR6502339.dups.pairs.gz
667M    SRR6502339.nodups.pairs.gz
1.1G    SRR6502339.sorted.pairs.gz
274M    SRR6502339.unmapped.pairs.gz</code></pre>
</div>
</div>
<div id="fc5a4a45-411e-4605-b042-c1264dc77fb2" class="cell" data-scrolled="true">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>ref<span class="op">=</span>..<span class="op">/</span>data<span class="op">/</span>links<span class="op">/</span>ucsc_ref<span class="op">/</span>misc<span class="op">/</span>rheMac10.chrom.sizes</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> INFILE <span class="kw">in</span> ..<span class="op">/</span>steps<span class="op">/</span>bwa<span class="op">/</span>PE<span class="op">/</span>pairs<span class="op">/</span><span class="bu">sorted</span><span class="op">/*</span>.nodups<span class="op">*;</span> do</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    base<span class="op">=</span>$(basename $INFILE .pairs.gz)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    outfile<span class="op">=</span>..<span class="op">/</span>steps<span class="op">/</span>bwa<span class="op">/</span>PE<span class="op">/</span>pairs<span class="op">/</span>cool<span class="op">/</span>$base<span class="fl">.10000</span>.cool</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    echo $base <span class="st">'--&gt;'</span> $outfile</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    cooler cload pairs <span class="op">\</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span>c1 <span class="dv">2</span> <span class="op">-</span>p1 <span class="dv">3</span> <span class="op">-</span>c2 <span class="dv">4</span> <span class="op">-</span>p2 <span class="dv">5</span> <span class="op">\</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>assembly rheMac10 <span class="op">\</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>chunksize <span class="dv">50000</span> <span class="op">\</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    $ref:<span class="dv">10000</span> <span class="op">\</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    $INFILE <span class="op">\</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    $outfile <span class="op">&amp;</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>done </span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>wait</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cooler-access-and-plot-hi-c-data" class="level1">
<h1><code>cooler</code>: access and plot Hi-C data</h1>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>First, we have to check the data output from HiCExplorer. The output is a <code>.cool</code> file, which is a binary format for storing Hi-C data. The file contains the binned contact matrix and the genomic coordinates of the bins.</p>
<p>The <code>cooler</code> package is a Python library for working with <code>.cool</code> files. It provides tools for reading, writing, and manipulating Hi-C data. The <code>cooltools</code> package is a collection of tools for analyzing Hi-C data, including normalization, visualization, and interaction calling.</p>
</section>
<section id="follow-cooler-walkthrough-from-the-documentation" class="level2">
<h2 class="anchored" data-anchor-id="follow-cooler-walkthrough-from-the-documentation">Follow <code>cooler</code> walkthrough from the documentation</h2>
<div id="445b04fa-9790-4f3a-88f9-9cbc18155c1b" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import the packages we will use</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> op</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> h5py</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cooler</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9732f6f5" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The following directive activates inline plotting</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="96606d8b-ef90-4fc4-88f2-f7a2e302db2b" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the filepath (I choose the uncorrected matrix)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>filepath <span class="op">=</span> <span class="st">"../steps/bowtie2/local/matrices/filtered_pooled_10kb.cool"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="direct-access-with-h5py" class="level3">
<h3 class="anchored" data-anchor-id="direct-access-with-h5py">Direct access with <code>h5py</code></h3>
<div id="1ae354b3-5a4e-4bb1-92f7-823efc1a7de8" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>h5 <span class="op">=</span> h5py.File(filepath, <span class="st">'r'</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>h5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>&lt;HDF5 file "filtered_pooled_10kb.cool" (mode r)&gt;</code></pre>
</div>
</div>
<div id="75ce8348-16d0-4a77-bbee-16b3c6c23fd9" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>h5.keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>&lt;KeysViewHDF5 ['bins', 'chroms', 'indexes', 'pixels']&gt;</code></pre>
</div>
</div>
<div id="d6a14187-25e0-414d-bb0c-9ab51cc5ca5c" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>h5[<span class="st">'pixels'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>&lt;HDF5 group "/pixels" (3 members)&gt;</code></pre>
</div>
</div>
<div id="6ddfd61f-92f8-4be3-9e28-dbfc91a6b667" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(h5[<span class="st">'pixels'</span>].keys())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>['bin1_id', 'bin2_id', 'count']</code></pre>
</div>
</div>
<p>h5py dataset objects are views onto the data on disk</p>
<div id="9f277dd7-6d30-49e0-aea4-0e2cd04a34fd" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>h5[<span class="st">'pixels'</span>][<span class="st">'bin2_id'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>&lt;HDF5 dataset "bin2_id": shape (117090191,), type "&lt;i4"&gt;</code></pre>
</div>
</div>
<p>Slicing or indexing returns a numpy array in memory.</p>
<div id="aab334bd-35e6-4540-9157-eeefb2d4f66c" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>h5[<span class="st">'pixels'</span>][<span class="st">'bin2_id'</span>][:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>array([   0,    9,   30,   33,  124,  127,  145,  756, 1167, 2416],
      dtype=int32)</code></pre>
</div>
</div>
<div id="8da804d9-ff8d-4f25-ad45-810ebe700b56" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>h5[<span class="st">'pixels'</span>][<span class="st">'count'</span>][:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>array([1., 1., 1., 1., 1., 1., 1., 1., 1., 1.])</code></pre>
</div>
</div>
<div id="8f6a4251-2e28-4fc6-9d1e-0317cdded59c" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>h5.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Python cooler package is just a thin wrapper over h5py.</p>
<ul>
<li>It lets you access the data tables as Pandas data frames and series.</li>
<li>It also provides a matrix abstraction: letting you query the upper triangle pixel table as if it were a full rectangular sparse matrix via SciPy.</li>
</ul>
</section>
<section id="the-cooler-class" class="level3">
<h3 class="anchored" data-anchor-id="the-cooler-class">The <code>Cooler</code> class</h3>
<p>Accepts a file path or an open HDF5 file object.</p>
<p>NOTE: Using a filepath allows the <code>Cooler</code> object to be serialized/pickled since the file is only opened when needed</p>
<div id="18135174-671f-4843-81c8-b0b034369ccd" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> cooler.Cooler(filepath)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="16b427a8-922c-4d56-a22b-0b76ea14111d" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>c.info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>{'bin-size': 10000,
 'bin-type': 'fixed',
 'creation-date': '2024-09-24T21:20:38.656143',
 'format': 'HDF5::Cooler',
 'format-url': 'https://github.com/mirnylab/cooler',
 'format-version': 3,
 'generated-by': 'HiCMatrix-17.2',
 'generated-by-cooler-lib': 'cooler-0.10.2',
 'genome-assembly': 'unknown',
 'metadata': {'format': 'HDF5::Cooler',
  'format-url': 'https://github.com/mirnylab/cooler',
  'generated-by': 'HiCMatrix-17.2',
  'generated-by-cooler-lib': 'cooler-0.10.2',
  'tool-url': 'https://github.com/deeptools/HiCMatrix'},
 'nbins': 285406,
 'nchroms': 22,
 'nnz': 117090191,
 'storage-mode': 'symmetric-upper',
 'sum': 193589731.0,
 'tool-url': 'https://github.com/deeptools/HiCMatrix'}</code></pre>
</div>
</div>
<div id="2b215da8-dd59-461c-85a6-e449e70b1ead" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>c.chroms()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>&lt;cooler.core._selectors.RangeSelector1D at 0x146a5acf1cd0&gt;</code></pre>
</div>
</div>
<p>The return value is a selector or “view” on a table that accepts column and range queries (“slices”).</p>
<ul>
<li>Column selections return a new view.</li>
<li>Range selections return pandas DataFrames or Series.</li>
</ul>
<div id="60745da2-ad77-4fa8-b1ef-0fdede48a137" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a slice of the chromosomes</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>c.chroms()[<span class="dv">0</span>:<span class="dv">5</span>]</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Or the whole dict</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co">#c.chroms()[:]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">length</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>chr1</td>
<td>223616942</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>chr2</td>
<td>196197964</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>chr3</td>
<td>185288947</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>chr4</td>
<td>169963040</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>chr5</td>
<td>187317192</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="4fa16853-6405-4ae2-af41-1f4acfe673aa" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convenience</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>c.chromnames, c.chromsizes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(['chr1',
  'chr2',
  'chr3',
  'chr4',
  'chr5',
  'chr6',
  'chr7',
  'chr8',
  'chr9',
  'chr10',
  'chr11',
  'chr12',
  'chr13',
  'chr14',
  'chr15',
  'chr16',
  'chr17',
  'chr18',
  'chr19',
  'chr20',
  'chrX',
  'chrY'],
 name
 chr1     223616942
 chr2     196197964
 chr3     185288947
 chr4     169963040
 chr5     187317192
 chr6     179085566
 chr7     169868564
 chr8     145679320
 chr9     134124166
 chr10     99517758
 chr11    133066086
 chr12    130043856
 chr13    108737130
 chr14    128056306
 chr15    113283604
 chr16     79627064
 chr17     95433459
 chr18     74474043
 chr19     58315233
 chr20     77137495
 chrX     153388924
 chrY      11753682
 Name: length, dtype: int32)</code></pre>
</div>
</div>
<div id="c0b295d5-86ca-43c8-ae69-44d26953c058" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Access bins</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>c.bins()[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">chrom</th>
<th data-quarto-table-cell-role="th">start</th>
<th data-quarto-table-cell-role="th">end</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>chr1</td>
<td>10000</td>
<td>20000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>chr1</td>
<td>30000</td>
<td>40000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>chr1</td>
<td>40000</td>
<td>50000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>chr1</td>
<td>50000</td>
<td>60000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>chr1</td>
<td>60000</td>
<td>70000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>chr1</td>
<td>70000</td>
<td>80000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>chr1</td>
<td>80000</td>
<td>90000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>chr1</td>
<td>90000</td>
<td>100000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Selecting a list of columns returns a new DataFrame view on that subset of columns</p>
<div id="dc5256e8-278e-4f7f-965e-728c2be229b1" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>bins <span class="op">=</span> c.bins()[[<span class="st">'chrom'</span>, <span class="st">'start'</span>, <span class="st">'end'</span>]]</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>bins</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>&lt;cooler.core._selectors.RangeSelector1D at 0x146a60464a40&gt;</code></pre>
</div>
</div>
<div id="c94a2d32-1262-471c-8f00-1a6fa5e18743" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>bins[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">chrom</th>
<th data-quarto-table-cell-role="th">start</th>
<th data-quarto-table-cell-role="th">end</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>chr1</td>
<td>10000</td>
<td>20000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>chr1</td>
<td>30000</td>
<td>40000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>chr1</td>
<td>40000</td>
<td>50000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The pixel table contains the non-zero upper triangle entries of the contact map.</p>
<div id="8fb3b186-1e8a-4126-9610-1833b975aea5" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the join=True option if you would like to expand the bin IDs into genomic bin coordinates by joining the output with the bin table.</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>display(c.pixels()[:<span class="dv">10</span>], c.pixels(join<span class="op">=</span><span class="va">True</span>)[:<span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">bin1_id</th>
<th data-quarto-table-cell-role="th">bin2_id</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>9</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>30</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>33</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>124</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0</td>
<td>127</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0</td>
<td>145</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>0</td>
<td>756</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>0</td>
<td>1167</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>0</td>
<td>2416</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">chrom1</th>
<th data-quarto-table-cell-role="th">start1</th>
<th data-quarto-table-cell-role="th">end1</th>
<th data-quarto-table-cell-role="th">chrom2</th>
<th data-quarto-table-cell-role="th">start2</th>
<th data-quarto-table-cell-role="th">end2</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
<td>chr1</td>
<td>90000</td>
<td>100000</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
<td>chr1</td>
<td>300000</td>
<td>310000</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
<td>chr1</td>
<td>330000</td>
<td>340000</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
<td>chr1</td>
<td>1240000</td>
<td>1250000</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
<td>chr1</td>
<td>1270000</td>
<td>1280000</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
<td>chr1</td>
<td>1450000</td>
<td>1460000</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
<td>chr1</td>
<td>7560000</td>
<td>7570000</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
<td>chr1</td>
<td>11670000</td>
<td>11680000</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
<td>chr1</td>
<td>24160000</td>
<td>24170000</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Dump any table selection with pandas to tabular</p>
<div id="f7d228e2-e6f2-45db-b9c5-4c9f9c566067" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> c.pixels(join<span class="op">=</span><span class="va">True</span>)[:<span class="dv">100</span>]</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co"># df.to_csv('data/myselection.txt'), sep='\t', index=False, header=False) </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="bin-annotation" class="level3">
<h3 class="anchored" data-anchor-id="bin-annotation">Bin annotation</h3>
<p>Another way to annotate the bins in a data frame of pixels is to use cooler.annotate. It does a left outer join from the bin1_id and bin2_id columns onto a data frame indexed by bin ID that describes the bins.</p>
<div id="62330aef-3fd1-4134-889f-2858f8ab934a" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>bins <span class="op">=</span> c.bins()[:] <span class="co"># fetch all</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>pix <span class="op">=</span> c.pixels()[<span class="dv">100</span>:<span class="dv">110</span>] <span class="co"># select some pixels</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>pix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">bin1_id</th>
<th data-quarto-table-cell-role="th">bin2_id</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">100</td>
<td>2</td>
<td>481</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">101</td>
<td>2</td>
<td>500</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">102</td>
<td>2</td>
<td>519</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">103</td>
<td>2</td>
<td>557</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">104</td>
<td>2</td>
<td>580</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">105</td>
<td>2</td>
<td>594</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">106</td>
<td>2</td>
<td>606</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">107</td>
<td>2</td>
<td>621</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">108</td>
<td>2</td>
<td>625</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">109</td>
<td>2</td>
<td>646</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="b2917d74-6579-4457-afba-7e2538b1d7e1" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>cooler.annotate(pix, bins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">chrom1</th>
<th data-quarto-table-cell-role="th">start1</th>
<th data-quarto-table-cell-role="th">end1</th>
<th data-quarto-table-cell-role="th">chrom2</th>
<th data-quarto-table-cell-role="th">start2</th>
<th data-quarto-table-cell-role="th">end2</th>
<th data-quarto-table-cell-role="th">bin1_id</th>
<th data-quarto-table-cell-role="th">bin2_id</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">100</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
<td>chr1</td>
<td>4810000</td>
<td>4820000</td>
<td>2</td>
<td>481</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">101</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
<td>chr1</td>
<td>5000000</td>
<td>5010000</td>
<td>2</td>
<td>500</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">102</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
<td>chr1</td>
<td>5190000</td>
<td>5200000</td>
<td>2</td>
<td>519</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">103</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
<td>chr1</td>
<td>5570000</td>
<td>5580000</td>
<td>2</td>
<td>557</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">104</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
<td>chr1</td>
<td>5800000</td>
<td>5810000</td>
<td>2</td>
<td>580</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">105</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
<td>chr1</td>
<td>5940000</td>
<td>5950000</td>
<td>2</td>
<td>594</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">106</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
<td>chr1</td>
<td>6060000</td>
<td>6070000</td>
<td>2</td>
<td>606</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">107</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
<td>chr1</td>
<td>6210000</td>
<td>6220000</td>
<td>2</td>
<td>621</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">108</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
<td>chr1</td>
<td>6250000</td>
<td>6260000</td>
<td>2</td>
<td>625</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">109</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
<td>chr1</td>
<td>6460000</td>
<td>6470000</td>
<td>2</td>
<td>646</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="eaacceea-e87d-497d-acee-bfecf3865026" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>cooler.annotate(pix, bins[[<span class="st">'start'</span>]], replace<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">start1</th>
<th data-quarto-table-cell-role="th">start2</th>
<th data-quarto-table-cell-role="th">bin1_id</th>
<th data-quarto-table-cell-role="th">bin2_id</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">100</td>
<td>20000</td>
<td>4810000</td>
<td>2</td>
<td>481</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">101</td>
<td>20000</td>
<td>5000000</td>
<td>2</td>
<td>500</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">102</td>
<td>20000</td>
<td>5190000</td>
<td>2</td>
<td>519</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">103</td>
<td>20000</td>
<td>5570000</td>
<td>2</td>
<td>557</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">104</td>
<td>20000</td>
<td>5800000</td>
<td>2</td>
<td>580</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">105</td>
<td>20000</td>
<td>5940000</td>
<td>2</td>
<td>594</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">106</td>
<td>20000</td>
<td>6060000</td>
<td>2</td>
<td>606</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">107</td>
<td>20000</td>
<td>6210000</td>
<td>2</td>
<td>621</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">108</td>
<td>20000</td>
<td>6250000</td>
<td>2</td>
<td>625</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">109</td>
<td>20000</td>
<td>6460000</td>
<td>2</td>
<td>646</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="enter-the-matrix" class="level3">
<h3 class="anchored" data-anchor-id="enter-the-matrix">Enter the Matrix</h3>
<p>Finally, the <code>matrix</code> method provides a 2D-sliceable view on the data. It allows you to query the data on file as a full rectangular contact matrix.</p>
<div id="6f93a797-2095-430d-9f95-7d907724bdf1" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>c.matrix()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>&lt;cooler.core._selectors.RangeSelector2D at 0x146a5ad44470&gt;</code></pre>
</div>
</div>
<div id="26715ad8-71a9-4769-ba72-eea35209825e" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>arr <span class="op">=</span> c.matrix(balance<span class="op">=</span><span class="va">False</span>)[<span class="dv">1000</span>:<span class="dv">1200</span>, <span class="dv">1000</span>:<span class="dv">1200</span>]</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>arr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>array([[ 57.,  33.,   9., ...,   0.,   1.,   0.],
       [ 33.,  88.,  33., ...,   1.,   0.,   0.],
       [  9.,  33.,  74., ...,   0.,   0.,   0.],
       ...,
       [  0.,   1.,   0., ..., 104.,  27.,  12.],
       [  1.,   0.,   0., ...,  27., 118.,  46.],
       [  0.,   0.,   0., ...,  12.,  46., 135.]])</code></pre>
</div>
</div>
<div id="d44945fd-5d61-429c-9968-fcb84ba448e9" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use sparse=True to return a scipy.sparse.coo_matrix in stead</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>mat <span class="op">=</span> c.matrix(balance<span class="op">=</span><span class="va">False</span>, sparse<span class="op">=</span><span class="va">True</span>)[<span class="dv">1000</span>:<span class="dv">1200</span>,<span class="dv">1000</span>:<span class="dv">1200</span>]</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>mat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>&lt;200x200 sparse matrix of type '&lt;class 'numpy.float64'&gt;'
    with 26544 stored elements in COOrdinate format&gt;</code></pre>
</div>
</div>
<p>Convert to a 2D numpy array</p>
<div id="25e1e74d-fb72-414b-bbe6-95abea4fa701" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>arr <span class="op">=</span> mat.toarray()</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>arr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>array([[ 57.,  33.,   9., ...,   0.,   1.,   0.],
       [ 33.,  88.,  33., ...,   1.,   0.,   0.],
       [  9.,  33.,  74., ...,   0.,   0.,   0.],
       ...,
       [  0.,   1.,   0., ..., 104.,  27.,  12.],
       [  1.,   0.,   0., ...,  27., 118.,  46.],
       [  0.,   0.,   0., ...,  12.,  46., 135.]])</code></pre>
</div>
</div>
<p>Notice that tha lower triangle has automatically been filled</p>
<div id="17d698c7-0e9c-4f7b-b5a4-382e3bf769a8" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>ax  <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>im  <span class="op">=</span> ax.matshow(np.log1p(arr), cmap<span class="op">=</span><span class="st">'Reds'</span>)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>fig.colorbar(im) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_open2c_framework_files/figure-html/cell-47-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="use-the-new-pairs" class="level2">
<h2 class="anchored" data-anchor-id="use-the-new-pairs">Use the new pairs</h2>
<div id="486cd437-1720-42c8-8b07-72c6a10ab894" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import the packages we will use</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> op</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> h5py</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cooler</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co"># The following directive activates inline plotting</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="121b7ac7-6b2d-49a3-9955-a57c125dad4b" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>filepath <span class="op">=</span> <span class="st">"../steps/bwa/PE/pairs/cool/SRR6502335.nodups.10000.cool"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2dfbdf36-f57f-4baf-8880-20a5305eb318" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> cooler.Cooler(filepath)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>c.info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>{'bin-size': 10000,
 'bin-type': 'fixed',
 'creation-date': '2024-10-08T14:31:29.159937',
 'format': 'HDF5::Cooler',
 'format-url': 'https://github.com/open2c/cooler',
 'format-version': 3,
 'generated-by': 'cooler-0.10.2',
 'genome-assembly': 'rheMac10',
 'metadata': {},
 'nbins': 298615,
 'nchroms': 2939,
 'nnz': 67535020,
 'storage-mode': 'symmetric-upper',
 'sum': 115865253}</code></pre>
</div>
</div>
<div id="dbe50efb-05d5-4f98-a8ce-7b95068af594" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>c.bins()[:<span class="dv">100</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">chrom</th>
<th data-quarto-table-cell-role="th">start</th>
<th data-quarto-table-cell-role="th">end</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>chr1</td>
<td>0</td>
<td>10000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>chr1</td>
<td>10000</td>
<td>20000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>chr1</td>
<td>20000</td>
<td>30000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>chr1</td>
<td>30000</td>
<td>40000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>chr1</td>
<td>40000</td>
<td>50000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>chr1</td>
<td>950000</td>
<td>960000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>chr1</td>
<td>960000</td>
<td>970000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>chr1</td>
<td>970000</td>
<td>980000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>chr1</td>
<td>980000</td>
<td>990000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>chr1</td>
<td>990000</td>
<td>1000000</td>
</tr>
</tbody>
</table>

<p>100 rows × 3 columns</p>
</div>
</div>
</div>
<div id="30e54175-121e-462a-b37a-78a8881f4aae" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>c.matrix()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>&lt;cooler.core._selectors.RangeSelector2D at 0x14e6604fdee0&gt;</code></pre>
</div>
</div>
<div id="76e56f86-5cff-42e0-a441-60b6340e7a17" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>arr <span class="op">=</span> c.matrix(balance<span class="op">=</span><span class="va">False</span>).fetch(<span class="st">'chrX'</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>arr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>array([[39,  0,  4, ...,  0,  0,  0],
       [ 0,  9,  3, ...,  0,  0,  0],
       [ 4,  3, 29, ...,  0,  0,  0],
       ...,
       [ 0,  0,  0, ...,  7,  0,  0],
       [ 0,  0,  0, ...,  0,  0,  0],
       [ 0,  0,  0, ...,  0,  0,  0]], dtype=int32)</code></pre>
</div>
</div>
<div id="8c30a25d-5da6-43f3-b907-3f2c61490572" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot with matplotlib</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span>  fig.add_subplot(<span class="dv">111</span>)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span>  ax.matshow(np.log1p(arr), cmap<span class="op">=</span><span class="st">"Reds"</span>)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>fig.colorbar(im)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="02_open2c_framework_files/figure-html/cell-54-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="merge-the-replicates-according-to-sra-id" class="level2">
<h2 class="anchored" data-anchor-id="merge-the-replicates-according-to-sra-id">Merge the replicates according to SRA ID</h2>
<section id="first-subset-the-chromosomes-to-only-the-real-chromosomes" class="level3">
<h3 class="anchored" data-anchor-id="first-subset-the-chromosomes-to-only-the-real-chromosomes">First, subset the chromosomes to only the real chromosomes</h3>
<div id="5e2767a5-1863-4c9b-9c9b-97b9e4a590b8" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(filepath)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(filepath.replace(<span class="st">'nodups'</span>, <span class="st">'subset.nodups'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>../steps/bwa/PE/pairs/cool/SRR6502335.nodups.10000.cool
../steps/bwa/PE/pairs/cool/SRR6502335.subset.nodups.10000.cool</code></pre>
</div>
</div>
<section id="make-a-loop" class="level4">
<h4 class="anchored" data-anchor-id="make-a-loop">Make a loop</h4>
<div id="4fc319e5-2af6-4878-bdb3-bb3196d2cc05" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cooler</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> op</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprintpp <span class="im">import</span> pprint <span class="im">as</span> pp</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>coolers <span class="op">=</span> [<span class="ss">f"../steps/bwa/PE/pairs/cool/SRR650233</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss">.nodups.10000.cool"</span> <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>,<span class="dv">10</span>)]</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Subsetting coolers and merging replicates from"</span>)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>pp(coolers)</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cool <span class="kw">in</span> coolers:</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filenames</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    cool_file <span class="op">=</span> cool</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    output_cool_file <span class="op">=</span> cool_file.replace(<span class="st">'nodups'</span>, <span class="st">'subset.nodups'</span>)</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> op.exists(output_cool_file):</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Skipping </span><span class="sc">{</span>cool_file<span class="sc">}</span><span class="ss">&nbsp;(exists)"</span>)</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Input: </span><span class="sc">{</span>cool_file<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">Output: </span><span class="sc">{</span>output_cool_file<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">Initializing cooler from input..."</span>)</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the original .cool file</span></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> cooler.Cooler(cool_file)</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the chromosomes to keep (e.g., excluding unplaced scaffolds/contigs)</span></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>    chroms_to_keep <span class="op">=</span> c.chroms()[<span class="dv">0</span>:<span class="dv">22</span>][<span class="st">'name'</span>]</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter the bins to include only the selected chromosomes</span></span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Filtering bins..."</span>)</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>    bins <span class="op">=</span> c.bins()[:]</span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>    filtered_bins <span class="op">=</span> bins[bins[<span class="st">'chrom'</span>].isin(chroms_to_keep)]</span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter the pixels to include only the selected bins</span></span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Filtering pixels..."</span>)</span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>    bin_ids_to_keep <span class="op">=</span> <span class="bu">set</span>(filtered_bins.index)</span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>    pixels <span class="op">=</span> c.pixels()[:]</span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a>    filtered_pixels <span class="op">=</span> pixels[pixels[<span class="st">'bin1_id'</span>].isin(bin_ids_to_keep) <span class="op">&amp;</span> pixels[<span class="st">'bin2_id'</span>].isin(bin_ids_to_keep)]</span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset the coolers</span></span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Creating subsetted cooler..."</span>)</span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>    cooler.create_cooler(</span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a>        cool_uri<span class="op">=</span>output_cool_file,</span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span>filtered_bins,</span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a>        pixels<span class="op">=</span>filtered_pixels,</span>
<span id="cb82-47"><a href="#cb82-47" aria-hidden="true" tabindex="-1"></a>        assembly<span class="op">=</span><span class="st">'rheMac10'</span>,  <span class="co"># Optional: specify the genome assembly</span></span>
<span id="cb82-48"><a href="#cb82-48" aria-hidden="true" tabindex="-1"></a>        ordered<span class="op">=</span><span class="va">True</span>,  <span class="co"># Assuming the input chunks are in the correct order</span></span>
<span id="cb82-49"><a href="#cb82-49" aria-hidden="true" tabindex="-1"></a>        symmetric_upper<span class="op">=</span><span class="va">True</span>,  <span class="co"># Assuming the input data references the upper triangle of a symmetric matrix</span></span>
<span id="cb82-50"><a href="#cb82-50" aria-hidden="true" tabindex="-1"></a>        mode<span class="op">=</span><span class="st">'w'</span>,  <span class="co"># Write mode</span></span>
<span id="cb82-51"><a href="#cb82-51" aria-hidden="true" tabindex="-1"></a>        ensure_sorted<span class="op">=</span><span class="va">True</span>,  <span class="co"># Ensure that each input chunk is properly sorted</span></span>
<span id="cb82-52"><a href="#cb82-52" aria-hidden="true" tabindex="-1"></a>        boundscheck<span class="op">=</span><span class="va">True</span>,  <span class="co"># Check that all bin IDs lie in the expected range</span></span>
<span id="cb82-53"><a href="#cb82-53" aria-hidden="true" tabindex="-1"></a>        dupcheck<span class="op">=</span><span class="va">True</span>,  <span class="co"># Check that no duplicate pixels exist within any chunk</span></span>
<span id="cb82-54"><a href="#cb82-54" aria-hidden="true" tabindex="-1"></a>        triucheck<span class="op">=</span><span class="va">True</span>  <span class="co"># Check that bin1_id &lt;= bin2_id when creating coolers in symmetric-upper mode</span></span>
<span id="cb82-55"><a href="#cb82-55" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-56"><a href="#cb82-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-57"><a href="#cb82-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Subset .cool file created: </span><span class="sc">{</span>output_cool_file<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Subsetting coolers and merging replicates from
[
    '../steps/bwa/PE/pairs/cool/SRR6502335.nodups.10000.cool',
    '../steps/bwa/PE/pairs/cool/SRR6502336.nodups.10000.cool',
    '../steps/bwa/PE/pairs/cool/SRR6502337.nodups.10000.cool',
    '../steps/bwa/PE/pairs/cool/SRR6502338.nodups.10000.cool',
    '../steps/bwa/PE/pairs/cool/SRR6502339.nodups.10000.cool',
]
Skipping ../steps/bwa/PE/pairs/cool/SRR6502335.nodups.10000.cool&nbsp;(exists)
Skipping ../steps/bwa/PE/pairs/cool/SRR6502336.nodups.10000.cool&nbsp;(exists)
Skipping ../steps/bwa/PE/pairs/cool/SRR6502337.nodups.10000.cool&nbsp;(exists)
Skipping ../steps/bwa/PE/pairs/cool/SRR6502338.nodups.10000.cool&nbsp;(exists)
Skipping ../steps/bwa/PE/pairs/cool/SRR6502339.nodups.10000.cool&nbsp;(exists)</code></pre>
</div>
</div>
<div id="2746a226-18fd-4623-9161-30ba70df0db0" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge rep1</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>rep1_out <span class="op">=</span> <span class="st">"../steps/bwa/PE/pairs/cool/fib_rep1.10000.cool"</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> op.exists(rep1_out):</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    cooler.merge_coolers(output_uri <span class="op">=</span> rep1_out,</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>                         input_uris <span class="op">=</span> [<span class="st">"../steps/bwa/PE/pairs/cool/SRR6502335.subset.nodups.10000.cool"</span>,</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"../steps/bwa/PE/pairs/cool/SRR6502336.subset.nodups.10000.cool"</span>],</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>                         mergebuf <span class="op">=</span> <span class="dv">20000000</span>)</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>rep1_out<span class="sc">}</span><span class="ss"> already exists"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>../steps/bwa/PE/pairs/cool/fib_rep1.10000.cool already exists</code></pre>
</div>
</div>
<div id="f97f25c8-ece9-408d-b2f6-8a09cc6b22af" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge rep2</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>rep2_out <span class="op">=</span> <span class="st">"../steps/bwa/PE/pairs/cool/fib_rep2.10000.cool"</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> op.exists(rep2_out):</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    cooler.merge_coolers(output_uri <span class="op">=</span> rep2_out,</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>                         input_uris <span class="op">=</span> [<span class="st">"../steps/bwa/PE/pairs/cool/SRR6502337.subset.nodups.10000.cool"</span>,</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"../steps/bwa/PE/pairs/cool/SRR6502338.subset.nodups.10000.cool"</span>,</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"../steps/bwa/PE/pairs/cool/SRR6502339.subset.nodups.10000.cool"</span>],</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>                         mergebuf <span class="op">=</span> <span class="dv">20000000</span>)</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>rep1_out<span class="sc">}</span><span class="ss"> already exists"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>../steps/bwa/PE/pairs/cool/fib_rep1.10000.cool already exists</code></pre>
</div>
</div>
<div id="5ffd313a-7a17-4f19-b1b7-1d67978d909b" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>c_rep1 <span class="op">=</span> cooler.Cooler(<span class="st">"../steps/bwa/PE/pairs/cool/fib_rep1.10000.cool"</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>c_rep2 <span class="op">=</span> cooler.Cooler(<span class="st">"../steps/bwa/PE/pairs/cool/fib_rep2.10000.cool"</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>pp(c_rep1.info) </span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>pp(c_rep2.info)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
    'bin-size': 10000,
    'bin-type': 'fixed',
    'creation-date': '2024-10-08T21:02:38.036175',
    'format': 'HDF5::Cooler',
    'format-url': 'https://github.com/open2c/cooler',
    'format-version': 3,
    'generated-by': 'cooler-0.10.2',
    'genome-assembly': 'rheMac10',
    'metadata': {},
    'nbins': 285406,
    'nchroms': 22,
    'nnz': 112572916,
    'storage-mode': 'symmetric-upper',
    'sum': 211718459,
}
{
    'bin-size': 10000,
    'bin-type': 'fixed',
    'creation-date': '2024-10-08T21:52:32.813516',
    'format': 'HDF5::Cooler',
    'format-url': 'https://github.com/open2c/cooler',
    'format-version': 3,
    'generated-by': 'cooler-0.10.2',
    'genome-assembly': 'rheMac10',
    'metadata': {},
    'nbins': 285406,
    'nchroms': 22,
    'nnz': 117207943,
    'storage-mode': 'symmetric-upper',
    'sum': 211294810,
}</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="zoomify-the-merged-replicates" class="level2">
<h2 class="anchored" data-anchor-id="zoomify-the-merged-replicates"><code>zoomify</code> the merged replicates</h2>
<p>Generate an <code>.mcool</code> file containing coarser resolution to be called.</p>
<div id="32b98cd1-d8e3-4a18-bfbf-3c50a83011f2" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cooler</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path <span class="im">as</span> op</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>cool_paths <span class="op">=</span> {<span class="st">'rep1'</span>: <span class="st">"../steps/bwa/PE/pairs/cool/fib_rep1.10000.cool"</span>,</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>              <span class="st">'rep2'</span>: <span class="st">"../steps/bwa/PE/pairs/cool/fib_rep2.10000.cool"</span>}</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>mcool_paths <span class="op">=</span> {<span class="st">'rep1'</span>: <span class="st">"../steps/bwa/PE/pairs/cool/fib_rep1.mcool"</span>,</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>               <span class="st">'rep2'</span>: <span class="st">"../steps/bwa/PE/pairs/cool/fib_rep2.mcool"</span>}</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cool,path <span class="kw">in</span> cool_paths.items():</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> op.exists(mcool_paths[cool]):</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Skipping: </span><span class="sc">{</span>mcool_paths[cool]<span class="sc">}</span><span class="ss"> already exists"</span>)</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Zoomifying cooler: </span><span class="ch">\n\t</span><span class="ss">   </span><span class="sc">{</span>path<span class="sc">}</span><span class="ch">\n\t</span><span class="ss">-&gt; </span><span class="sc">{</span>mcool_paths[cool]<span class="sc">}</span><span class="ss">"</span>, end<span class="op">=</span><span class="st">"</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>    cooler.zoomify_cooler(base_uris <span class="op">=</span> path,</span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>                          outfile <span class="op">=</span> mcool_paths[cool],</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>                          resolutions <span class="op">=</span> [<span class="dv">10000</span>,<span class="dv">50000</span>,<span class="dv">100000</span>,<span class="dv">500000</span>],</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>                          chunksize <span class="op">=</span> <span class="dv">10000000</span>,</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>                          nproc <span class="op">=</span> <span class="dv">4</span>)</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">" --&gt; done"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Zoomifying cooler: 
       ../steps/bwa/PE/pairs/cool/fib_rep1.10000.cool
    -&gt; ../steps/bwa/PE/pairs/cool/fib_rep1.mcool
 --&gt; done
Zoomifying cooler: 
       ../steps/bwa/PE/pairs/cool/fib_rep2.10000.cool
    -&gt; ../steps/bwa/PE/pairs/cool/fib_rep2.mcool
 --&gt; done</code></pre>
</div>
</div>
<div id="6c0840fd-dd0b-4dc1-b253-90ba7a24bb25" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to print which resolutions are stored in the mcool, use list_coolers</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>cooler.fileops.list_coolers(mcool_paths[<span class="st">'rep1'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>['/resolutions/10000',
 '/resolutions/50000',
 '/resolutions/100000',
 '/resolutions/500000']</code></pre>
</div>
</div>
<div id="c2734d66-8cd0-4513-ac10-da55462442c5" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyError</span>                                  Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[93], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> cooler<span style="color:rgb(98,98,98)">.</span>Cooler(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">../steps/bwa/PE/pairs/cool/fib_rep1.mcool::0</span><span style="color:rgb(175,0,0)">"</span>)<span style="color:rgb(98,98,98)">.</span>info

File <span class="ansi-green-fg">~/miniconda3/envs/hic/lib/python3.12/site-packages/cooler/api.py:88</span>, in <span class="ansi-cyan-fg">Cooler.__init__</span><span class="ansi-blue-fg">(self, store, root, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     86</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>store <span style="color:rgb(98,98,98)">=</span> store<span style="color:rgb(98,98,98)">.</span>file
<span class="ansi-green-fg ansi-bold">     87</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>open_kws <span style="color:rgb(98,98,98)">=</span> {}
<span class="ansi-green-fg">---&gt; 88</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_refresh()

File <span class="ansi-green-fg">~/miniconda3/envs/hic/lib/python3.12/site-packages/cooler/api.py:109</span>, in <span class="ansi-cyan-fg">Cooler._refresh</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    104</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">len</span>(listing):
<span class="ansi-green-fg ansi-bold">    105</span>     err_msg <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> (
<span class="ansi-green-fg ansi-bold">    106</span>         <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)"> Coolers found in </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>listing<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">. </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    107</span>         <span style="color:rgb(98,98,98)">+</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Use </span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">::</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)"> to specify a group path</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    108</span>     )
<span class="ansi-green-fg">--&gt; 109</span> <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">KeyError</span>(err_msg) <span style="font-weight:bold;color:rgb(0,135,0)">from</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

<span class="ansi-red-fg">KeyError</span>: "No cooler found at: ../steps/bwa/PE/pairs/cool/fib_rep1.mcool. Coolers found in ['/resolutions/10000', '/resolutions/50000', '/resolutions/100000', '/resolutions/500000']. Use '::' to specify a group path"</pre>
</div>
</div>
</div>
<div id="3f5dcfae-664b-4eeb-a586-272445f37571" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>c1 <span class="op">=</span> cooler.Cooler(<span class="st">"../steps/bwa/PE/pairs/cool/fib_rep1.mcool::resolutions/100000"</span>)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>c2 <span class="op">=</span> cooler.Cooler(<span class="st">"../steps/bwa/PE/pairs/cool/fib_rep2.mcool::resolutions/100000"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f3fe5ce6-59d9-4f25-99d6-4d7b3a6325f5" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>c1.info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>{'bin-size': 100000,
 'bin-type': 'fixed',
 'creation-date': '2024-10-08T22:49:39.812053',
 'format': 'HDF5::Cooler',
 'format-url': 'https://github.com/open2c/cooler',
 'format-version': 3,
 'generated-by': 'cooler-0.10.2',
 'genome-assembly': 'unknown',
 'metadata': {},
 'nbins': 28550,
 'nchroms': 22,
 'nnz': 55668465,
 'storage-mode': 'symmetric-upper',
 'sum': 211294810}</code></pre>
</div>
</div>
<div id="2a06c70f-4d58-4e99-8230-0a73aec38136" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>arr1 <span class="op">=</span> c1.matrix(balance<span class="op">=</span><span class="va">False</span>).fetch(<span class="st">'chrX'</span>)</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>arr2 <span class="op">=</span> c2.matrix(balance<span class="op">=</span><span class="va">False</span>).fetch(<span class="st">'chrX'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-cooler-map-uncorrected-100kb" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot with matplotlib</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">10</span>))</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the first replicate</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>im1 <span class="op">=</span> ax1.matshow(np.log1p(arr1), cmap<span class="op">=</span><span class="st">"Reds"</span>)</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Replicate 1'</span>)</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>fig.colorbar(im1, ax<span class="op">=</span>ax1)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the second replicate</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>im2 <span class="op">=</span> ax2.matshow(np.log1p(arr2), cmap<span class="op">=</span><span class="st">"Reds"</span>)</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Replicate 2'</span>)</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>fig.colorbar(im2, ax<span class="op">=</span>ax2)</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="cooler-map-uncorrected-100kb" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="02_open2c_framework_files/figure-html/cooler-map-uncorrected-100kb-output-1.png" class="img-fluid figure-img"></p>
<figcaption>The X chromosome in 100kb bins and the first 3 PCs below. UNCORRECTED. Made with <code>cooler</code>.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="balance-the-matrices-iterative-correction" class="level2">
<h2 class="anchored" data-anchor-id="balance-the-matrices-iterative-correction">Balance the matrices (iterative correction)</h2>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../notebooks/01_hicexplorer.html" class="pagination-link" aria-label="HiCExplorer using macaque data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">HiCExplorer using macaque data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../gwf_map_reads.html" class="pagination-link" aria-label="gwf_map_reads">
        <span class="nav-page-text"><span class="chapter-title">gwf_map_reads</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>